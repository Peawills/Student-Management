{% extends 'records/base.html' %}
{% load academic_filters %}
{% block title %}Report Card Details - {{ report_card.student.full_name }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <!-- Header with Navigation -->
    <div class="mb-8">
        <a href="{% url 'academics:report_card_list' %}" class="inline-flex items-center gap-2 text-gray-700 font-semibold hover:text-primary-600 transition-colors mb-6">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg> Back to Report Cards
        </a>

        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <h1 class="text-4xl font-bold text-gray-800">{{ report_card.student.full_name }}</h1>
                    <span class="px-3 py-1 text-sm font-bold rounded-full {% if report_card.status == 'Published' %}bg-green-100 text-green-800{% elif report_card.status == 'Draft' %}bg-yellow-100 text-yellow-800{% else %}bg-gray-100 text-gray-800{% endif %}">
                        {{ report_card.status }}
                    </span>
                </div>
                <p class="text-gray-600">{{ report_card.classroom }} ‚Ä¢ {{ report_card.term }} ‚Ä¢ Admission: {{ report_card.student.admission_no }}</p>
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3">
                {% if user.is_superuser %}
                {% if report_card.status != 'Published' %}
                <form method="post" action="{% url 'academics:publish_report_card' report_card.pk %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> Publish
                    </button>
                </form>
                {% else %}
                <form method="post" action="{% url 'academics:unpublish_report_card' report_card.pk %}" class="inline">
                    {% csrf_token %}
                    <button type="submit" class="px-4 py-2 border-2 border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg> Unpublish
                    </button>
                </form>
                {% endif %}
                {% endif %}

                <a href="{% url 'academics:report_card_pdf' report_card.pk %}" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M7.875 14.25l7.5-7.5" />
                    </svg> Download PDF
                </a>

                <button onclick="window.print()" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.72 13.829c-.24.03-.48.062-.72.096m.72-.096a60.773 60.773 0 012.25-.384m0 0a57.5 57.5 0 015.648 0m2.25.384m-.024-11.384a23.364 23.364 0 00-5.648 0m11.648 0a23.37 23.37 0 00-5.648 0" />
                    </svg> Print
                </button>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="mb-6 border-b border-gray-200">
        <div class="flex flex-wrap gap-8">
            <button onclick="showTab('overview')" class="tab-btn active py-4 px-2 border-b-3 border-primary-500 text-primary-600 font-semibold transition-colors" data-tab="overview">
                Overview
            </button>
            <button onclick="showTab('performance')" class="tab-btn py-4 px-2 border-b-3 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition-colors" data-tab="performance">
                Performance
            </button>
            <button onclick="showTab('attendance')" class="tab-btn py-4 px-2 border-b-3 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition-colors" data-tab="attendance">
                Attendance
            </button>
            <button onclick="showTab('conduct')" class="tab-btn py-4 px-2 border-b-3 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition-colors" data-tab="conduct">
                Conduct
            </button>
            <button onclick="showTab('trends')" class="tab-btn py-4 px-2 border-b-3 border-transparent text-gray-600 font-semibold hover:text-gray-900 transition-colors" data-tab="trends">
                Trends & Insights
            </button>
        </div>
    </div>

    <!-- TAB 1: OVERVIEW -->
    <div id="overview" class="tab-content block">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Performance Badge -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-lg p-8 text-center">
                    <div class="mb-4">
                        <div class="text-6xl font-bold {% if report_card.average_score >= 90 %}text-green-600{% elif report_card.average_score >= 80 %}text-blue-600{% elif report_card.average_score >= 70 %}text-yellow-600{% elif report_card.average_score >= 60 %}text-orange-600{% else %}text-red-600{% endif %}">
                            {{ report_card.average_score|floatformat:0 }}%
                        </div>
                        <div class="text-lg font-bold mt-2">
                            {% if report_card.average_score >= 90 %}
                            <span class="inline-block px-4 py-2 rounded-full bg-green-100 text-green-800">Excellent</span>
                            {% elif report_card.average_score >= 80 %}
                            <span class="inline-block px-4 py-2 rounded-full bg-blue-100 text-blue-800">Good</span>
                            {% elif report_card.average_score >= 70 %}
                            <span class="inline-block px-4 py-2 rounded-full bg-yellow-100 text-yellow-800">Average</span>
                            {% elif report_card.average_score >= 60 %}
                            <span class="inline-block px-4 py-2 rounded-full bg-orange-100 text-orange-800">Fair</span>
                            {% else %}
                            <span class="inline-block px-4 py-2 rounded-full bg-red-100 text-red-800">Poor</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="mt-6 pt-6 border-t">
                        <div class="text-sm text-gray-600 mb-2">Overall Performance</div>
                        <div class="h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-primary-500 to-secondary-500" style="width: {{ report_card.average_score }}%"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="lg:col-span-2 grid grid-cols-2 gap-4">
                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-primary-500">
                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Class Position</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2">{{ report_card.position }}<span class="text-lg text-gray-500">/{{ report_card.out_of }}</span></div>
                </div>
                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-blue-500">
                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Total Score</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2">{{ report_card.total_score|floatformat:1 }}</div>
                </div>
                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-green-500">
                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Attendance</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2">{{ report_card.attendance_percentage|floatformat:1 }}%</div>
                </div>
                <div class="bg-white rounded-xl shadow p-6 border-l-4 border-yellow-500">
                    <div class="text-sm font-semibold text-gray-600 uppercase tracking-wide">Days Present</div>
                    <div class="text-3xl font-bold text-gray-800 mt-2">{{ report_card.days_present }}</div>
                </div>
            </div>
        </div>

        <!-- Summary & Remarks -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Class Teacher Remarks -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-6 py-4">
                    <h3 class="text-lg font-bold">üí¨ Class Teacher's Remarks</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 leading-relaxed">{{ report_card.class_teacher_remarks|default:"No remarks provided" }}</p>
                </div>
            </div>

            <!-- Principal's Remarks -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-4">
                    <h3 class="text-lg font-bold">üë®‚Äçüíº Principal's Remarks</h3>
                </div>
                <div class="p-6">
                    <p class="text-gray-700 leading-relaxed">{{ report_card.principal_remarks|default:"No remarks provided" }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 2: PERFORMANCE DETAILS -->
    <div id="performance" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-6 py-4">
                <h3 class="text-lg font-bold">üìö Subject Performance</h3>
            </div>
            <div class="p-6">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Subject</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">CA</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Exam</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Total</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Grade</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Rank</th>
                                <th class="px-6 py-4 text-left text-sm font-semibold text-gray-700">Progress</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for result in term_results %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-6 py-4 font-medium text-gray-900">{{ result.subject.name }}</td>
                                <td class="px-6 py-4 text-gray-700">{{ result.ca_total|default:"‚Äî" }}</td>
                                <td class="px-6 py-4 text-gray-700">{{ result.exam_score|default:"‚Äî" }}</td>
                                <td class="px-6 py-4 font-bold text-gray-900">{{ result.total_score }}</td>
                                <td class="px-6 py-4">
                                    <span class="px-3 py-1 text-xs font-bold rounded-full {% if result.grade == 'A' %}bg-green-100 text-green-800{% elif result.grade == 'B' %}bg-blue-100 text-blue-800{% elif result.grade == 'C' %}bg-cyan-100 text-cyan-800{% elif result.grade == 'D' %}bg-yellow-100 text-yellow-800{% else %}bg-red-100 text-red-800{% endif %}">
                                        {{ result.grade }}
                                    </span>
                                </td>
                                <td class="px-6 py-4 text-gray-700">{{ result.position|default:"‚Äî" }}</td>
                                <td class="px-6 py-4">
                                    <div class="w-24 bg-gray-200 rounded-full h-2">
                                        <div class="bg-gradient-to-r from-primary-500 to-secondary-500 h-2 rounded-full" style="width: {{ result.total_score }}%"></div>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-6 py-12 text-center text-gray-500">
                                    No subject results available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 3: ATTENDANCE & CONDUCT -->
    <div id="attendance" class="tab-content hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center border-t-4 border-green-500">
                <div class="text-5xl font-bold text-green-600">{{ report_card.days_present }}</div>
                <div class="text-lg font-semibold text-gray-700 mt-3">Days Present</div>
                <div class="text-sm text-gray-500 mt-1">Regular attendance</div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center border-t-4 border-red-500">
                <div class="text-5xl font-bold text-red-600">{{ report_card.days_absent }}</div>
                <div class="text-lg font-semibold text-gray-700 mt-3">Days Absent</div>
                <div class="text-sm text-gray-500 mt-1">School absences</div>
            </div>
            <div class="bg-white rounded-2xl shadow-lg p-8 text-center border-t-4 border-blue-500">
                <div class="text-5xl font-bold text-blue-600">{{ report_card.attendance_percentage|floatformat:1 }}%</div>
                <div class="text-lg font-semibold text-gray-700 mt-3">Attendance Rate</div>
                <div class="text-sm text-gray-500 mt-1">Overall performance</div>
            </div>
        </div>
    </div>

    <!-- TAB 4: CONDUCT & SKILLS -->
    <div id="conduct" class="tab-content hidden">
        <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white px-6 py-4">
                <h3 class="text-lg font-bold">üéØ Skills & Comportment Assessment</h3>
            </div>
            <div class="p-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    {% for field, label in report_card.get_skill_fields.items %}
                        {% with value=report_card|get_attr:field %}
                        {% if value %}
                        <div class="bg-gradient-to-br from-gray-50 to-white rounded-xl p-6 border-l-4 border-primary-500 shadow-sm">
                            <h4 class="font-bold text-gray-800 mb-4">{{ label }}</h4>
                            <div class="flex items-center gap-3">
                                <div class="flex-shrink-0">
                                    {% if value == 5 %}
                                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6 text-green-600">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>
                                    </div>
                                    {% elif value == 4 %}
                                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                                        <span class="text-lg font-bold text-blue-600">‚úì</span>
                                    </div>
                                    {% elif value == 3 %}
                                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100">
                                        <span class="text-lg font-bold text-yellow-600">‚Üí</span>
                                    </div>
                                    {% elif value == 2 %}
                                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-orange-100">
                                        <span class="text-lg font-bold text-orange-600">!</span>
                                    </div>
                                    {% else %}
                                    <div class="flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                                        <span class="text-lg font-bold text-red-600">‚úó</span>
                                    </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-gray-800">{{ value|get_skill_label }}</div>
                                    <div class="text-xs text-gray-500 mt-1">Rating: {{ value }}/5</div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        {% endwith %}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- TAB 5: TRENDS & INSIGHTS -->
    <div id="trends" class="tab-content hidden">
        <div class="space-y-6">
            <!-- Performance Trend -->
            {% if report_card.performance_trend %}
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4">üìà Performance Trend</h3>
                <div class="flex items-center gap-4">
                    {% if report_card.performance_trend == 'Improving' %}
                    <div class="text-4xl">üì∂</div>
                    <div>
                        <div class="text-2xl font-bold text-green-600">Improving</div>
                        <p class="text-gray-600">Student's performance is showing positive improvement</p>
                    </div>
                    {% elif report_card.performance_trend == 'Stable' %}
                    <div class="text-4xl">‚û°Ô∏è</div>
                    <div>
                        <div class="text-2xl font-bold text-blue-600">Stable</div>
                        <p class="text-gray-600">Student's performance remains consistent</p>
                    </div>
                    {% elif report_card.performance_trend == 'Declining' %}
                    <div class="text-4xl">üìâ</div>
                    <div>
                        <div class="text-2xl font-bold text-red-600">Declining</div>
                        <p class="text-gray-600">Performance shows a downward trend - intervention recommended</p>
                    </div>
                    {% else %}
                    <div class="text-4xl">‚ö†Ô∏è</div>
                    <div>
                        <div class="text-2xl font-bold text-yellow-600">Inconsistent</div>
                        <p class="text-gray-600">Performance varies significantly across subjects</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Recommendation -->
            {% if report_card.next_term_recommendation %}
            <div class="bg-white rounded-2xl shadow-lg p-8 border-l-4 border-green-500">
                <h3 class="text-lg font-bold text-gray-800 mb-4">‚úÖ Academic Recommendation</h3>
                <div class="bg-green-50 border border-green-200 rounded-lg p-6">
                    <p class="text-lg font-semibold text-green-800">{{ report_card.next_term_recommendation }}</p>
                    {% if report_card.internal_notes %}
                    <p class="text-gray-700 mt-4">{{ report_card.internal_notes }}</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}

            <!-- Benchmark Comparison -->
            {% if report_card.benchmark_data %}
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-lg font-bold text-gray-800 mb-6">üìä Benchmark Comparison</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-gradient-to-br from-primary-50 to-primary-100 rounded-lg p-6">
                        <div class="text-sm font-semibold text-primary-700 uppercase">Your Score</div>
                        <div class="text-3xl font-bold text-primary-900 mt-2">{{ report_card.average_score|floatformat:1 }}%</div>
                    </div>
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg p-6">
                        <div class="text-sm font-semibold text-gray-700 uppercase">Class Average</div>
                        <div class="text-3xl font-bold text-gray-900 mt-2">{{ report_card.benchmark_data.class_avg|default:"N/A" }}</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

</div>

<script>
function showTab(tabName) {
    // Hide all tabs
    const tabs = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => tab.classList.add('hidden'));

    // Remove active state from all buttons
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
        btn.classList.remove('border-primary-500', 'text-primary-600');
        btn.classList.add('border-transparent', 'text-gray-600');
    });

    // Show selected tab
    const selectedTab = document.getElementById(tabName);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
    }

    // Add active state to clicked button
    const activeBtn = document.querySelector(`.tab-btn[data-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.remove('border-transparent', 'text-gray-600');
        activeBtn.classList.add('border-primary-500', 'text-primary-600');
    }
}
</script>

<style>
    @media print {
        .tab-content { display: block !important; }
        .tab-content.hidden { display: none !important; }
        #overview { display: block !important; }
        #performance, #attendance, #conduct, #trends { display: none !important; }
    }
</style>
{% endblock %}
