{% extends "records/base.html" %}
{% load static %}

{% block title %}{{ student.full_name }} - Student Details{% endblock %}

{% block extra_css %}
<!-- No extra CSS needed, using Tailwind utilities -->
{% endblock %}

{% block content %}
<div class="container mx-auto px-4">
    <!-- Back Button -->
    <div class="my-6">
        <a href="{% url 'records:student_list' %}"
            class="inline-flex items-center gap-2 text-primary-600 font-semibold hover:text-secondary-500 transition-colors">
            <i class="bi bi-arrow-left-circle"></i>
            Back to Student List
        </a>
    </div>

    <!-- Profile Header -->
    <div
        class="p-6 md:p-8 bg-gradient-to-br from-primary-500 to-secondary-500 text-white rounded-2xl mb-8 shadow-lg">
        <div class="flex flex-col md:flex-row items-center gap-6 md:gap-8">
            <div class="flex-shrink-0">
                {% if student.student_image %}
                <img src="{{ student.student_image.url }}" alt="{{ student.full_name }}"
                    class="w-32 h-32 md:w-40 md:h-40 rounded-full object-cover border-4 border-white shadow-2xl">
                {% else %}
                <div
                    class="w-32 h-32 md:w-40 md:h-40 rounded-full bg-white/20 flex items-center justify-center text-5xl font-bold border-4 border-white shadow-2xl">
                    {{ student.surname.0|upper }}
                </div>
                {% endif %}
            </div>

            <div class="flex-grow text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-bold">{{ student.full_name }}</h1>
                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-4">
                    <div class="profile-badge">
                        <i class="bi bi-card-text"></i>
                        {{ student.admission_no }}
                    </div>
                    <div class="profile-badge">
                        <i class="bi bi-book"></i>
                        {{ student.class_at_present }}
                    </div>
                    <div class="profile-badge">
                        <i class="bi bi-calendar"></i>
                        {{ student.age }} years old
                    </div>
                    <div class="profile-badge">
                        <i class="bi bi-gender-{{ student.sex|lower }}"></i>
                        {{ student.sex }}
                    </div>
                    <div
                        class="profile-badge {% if student.is_active %}bg-green-500/80{% else %}bg-gray-500/80{% endif %}">
                        {% if student.is_active %}
                        <i class="bi bi-check-circle"></i>
                        Active
                        {% else %}
                        <i class="bi bi-archive"></i>
                        Archived
                        {% endif %}
                    </div>
                </div>

                <div class="flex flex-wrap justify-center md:justify-start gap-3 mt-6">
                    <a href="{% url 'records:upload_document' student.id %}" class="action-btn bg-white text-primary-600">
                        <i class="bi bi-cloud-upload"></i> Upload Document
                    </a>

                    <a href="{% url 'records:student_update' student.pk %}" class="action-btn bg-yellow-500 text-white">
                        <i class="bi bi-pencil"></i> Edit
                    </a>
                    {% if request.user.is_superuser %}
                    <form action="{% url 'academics:generate_single_report_card' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="student_id" value="{{ student.id }}">
                        {% if student.classroom %}
                        <input type="hidden" name="classroom_id" value="{{ student.classroom.id }}">
                        {% endif %}
                        <button type="submit" class="action-btn bg-blue-500 text-white"
                            title="Generate report card for current term">
                            <i class="bi bi-file-earmark-plus"></i> Generate Report Card
                        </button>
                    </form>
                    {% endif %}
                    <form action="{% url 'records:toggle_student_status' student.pk %}" method="post">
                        {% csrf_token %}
                        {% if student.is_active %}
                        <button type="submit" class="action-btn bg-orange-500 text-white"
                            onclick="return confirm('Are you sure you want to archive this student?')">
                            <i class="bi bi-archive"></i> Archive
                        </button>
                        {% else %}
                        <button type="submit" class="action-btn bg-green-500 text-white"
                            onclick="return confirm('Are you sure you want to reactivate this student?')">
                            <i class="bi bi-arrow-counterclockwise"></i> Reactivate
                        </button>
                        {% endif %}
                    </form>
                    <a href="{% url 'records:student_delete' student.pk %}" class="action-btn bg-red-600 text-white"
                        onclick="return confirm('Are you sure you want to delete this student? This action cannot be undone.')">
                        <i class="bi bi-trash"></i> Delete
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Personal Information -->
        <div class="info-card">
            <h3 class="section-title"><i class="bi bi-person-badge"></i>Personal Information</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Date of Birth</div>
                    <div class="info-value">{{ student.date_of_birth|date:"F d, Y" }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Place of Birth</div>
                    <div class="info-value">{{ student.place_of_birth }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nationality</div>
                    <div class="info-value">{{ student.nationality }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">State of Origin</div>
                    <div class="info-value">{{ student.state_of_origin }}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">LGA</div>
                    <div class="info-value">{{ student.lga }}</div>
                </div>
                {% if student.religion %}
                <div class="info-item">
                    <div class="info-label">Religion</div>
                    <div class="info-value">
                        {{ student.religion }}
                        {% if student.denomination %} - {{ student.denomination }}{% endif %}
                    </div>
                </div>
                {% endif %}
                {% if student.nin_no %}
                <div class="info-item">
                    <div class="info-label">NIN Number</div>
                    <div class="info-value">{{ student.nin_no }}</div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Contact & Academic -->
        <div class="space-y-8">
            <div class="info-card">
                <h3 class="section-title"><i class="bi bi-building"></i>Academic Information</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Date of Entry</div>
                        <div class="info-value">{{ student.date_of_entry|date:"F d, Y" }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Class on Entry</div>
                        <div class="info-value">{{ student.class_on_entry }}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Current Class</div>
                        <div class="info-value">{{ student.class_at_present }}</div>
                    </div>
                </div>
            </div>

            <div class="info-card">
                <h3 class="section-title"><i class="bi bi-geo-alt"></i>Contact Information</h3>
                <div class="info-grid grid-cols-1">
                    <div class="info-item">
                        <div class="info-label">Residential Address</div>
                        <div class="info-value">{{ student.residential_address }}</div>
                    </div>
                    {% if student.permanent_home_address %}
                    <div class="info-item">
                        <div class="info-label">Permanent Home Address</div>
                        <div class="info-value">{{ student.permanent_home_address }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Parent/Guardian Information -->
    <div class="info-card">
        <h3 class="section-title"><i class="bi bi-people"></i>Parent/Guardian Information</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            <div class="space-y-4">
                <h4 class="parent-title"><i class="bi bi-person"></i> Father</h4>
                <div class="info-item"><span class="info-label">Name</span><span class="info-value">{{ student.father_name }}</span></div>
                {% if student.father_occupation %}<div class="info-item"><span class="info-label">Occupation</span><span class="info-value">{{ student.father_occupation }}</span></div>{% endif %}
                {% if student.father_mobile %}<div class="info-item"><span class="info-label">Mobile</span><span class="info-value">{{ student.father_mobile }}</span></div>{% endif %}
            </div>

            <div class="space-y-4">
                <h4 class="parent-title"><i class="bi bi-person"></i> Mother</h4>
                <div class="info-item"><span class="info-label">Name</span><span class="info-value">{{ student.mother_name }}</span></div>
                {% if student.mother_occupation %}<div class="info-item"><span class="info-label">Occupation</span><span class="info-value">{{ student.mother_occupation }}</span></div>{% endif %}
                {% if student.mother_mobile %}<div class="info-item"><span class="info-label">Mobile</span><span class="info-value">{{ student.mother_mobile }}</span></div>{% endif %}
            </div>

            {% if student.guardian_name %}
            <div class="space-y-4">
                <h4 class="parent-title"><i class="bi bi-person-check"></i> Guardian</h4>
                <div class="info-item"><span class="info-label">Name</span><span class="info-value">{{ student.guardian_name }}</span></div>
                {% if student.guardian_occupation %}<div class="info-item"><span class="info-label">Occupation</span><span class="info-value">{{ student.guardian_occupation }}</span></div>{% endif %}
                {% if student.guardian_mobile %}<div class="info-item"><span class="info-label">Mobile</span><span class="info-value">{{ student.guardian_mobile }}</span></div>{% endif %}
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Health Status -->
    {% if student.visually_impaired or student.deaf or student.physically_disabled or student.mentally_impaired or student.others %}
    <div class="info-card">
        <h3 class="section-title"><i class="bi bi-heart-pulse"></i>Special Health Status</h3>
        <div class="flex flex-wrap gap-4">
            {% if student.visually_impaired %}
            <div class="health-badge"><i class="bi bi-eye-slash"></i> Visually Impaired</div>
            {% endif %}
            {% if student.deaf %}
            <div class="health-badge"><i class="bi bi-ear-slash"></i> Deaf</div>
            {% endif %}
            {% if student.physically_disabled %}
            <div class="health-badge"><i class="bi bi-person-wheelchair"></i> Physically Disabled</div>
            {% endif %}
            {% if student.mentally_impaired %}
            <div class="health-badge"><i class="bi bi-brain"></i> Mentally Impaired</div>
            {% endif %}
        </div>
        {% if student.others %}
        <div class="mt-4 pt-4 border-t border-gray-200">
            <strong class="text-gray-700">Additional Information:</strong>
            <p class="mt-2 text-gray-600 bg-gray-50 p-3 rounded-lg">{{ student.others }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Documents Section -->
    <div class="info-card">
        <h3 class="section-title"><i class="bi bi-file-earmark-text"></i>Documents ({{ document_count }})</h3>

        {% if grouped_documents %}
        {% for doc_type, docs in grouped_documents.items %}
        <div class="mb-8 last:mb-0">
            <div class="bg-primary-50 p-4 rounded-xl mb-4">
                <h4 class="text-lg font-bold text-primary-700 flex items-center gap-3"><i class="bi bi-folder2-open"></i>{{ doc_type }} ({{ docs|length }})</h4>
            </div>

            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {% for document in docs %}
                <div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300">
                    <div class="h-48 bg-gray-100 flex items-center justify-center relative group cursor-pointer"
                        onclick="viewDocument('{{ document.file.url }}', {{ document.is_image|yesno:'true,false' }})">
                        {% if document.is_image %}
                        <img src="{{ document.file.url }}" alt="{{ document.name }}" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="bi bi-zoom-in text-white text-4xl"></i>
                        </div>
                        {% elif document.is_pdf %}
                        <i class="bi bi-file-earmark-pdf text-5xl text-red-500"></i>
                        {% else %}
                        <i class="bi bi-file-earmark-text text-5xl text-primary-500"></i>
                        {% endif %}
                    </div>

                    <div class="p-4">
                        <h5 class="font-bold text-gray-800 truncate">{{ document.name }}</h5>
                        <div class="text-xs text-gray-500 mt-2 space-y-1">
                            <p><i class="bi bi-calendar3 mr-1.5"></i>{{ document.uploaded_at|date:"M d, Y" }}</p>
                            <p><i class="bi bi-hdd mr-1.5"></i>{{ document.file_size_mb }} MB</p>
                        </div>
                        {% if document.notes %}
                        <p class="text-xs text-gray-600 mt-2 p-2 bg-gray-100 rounded-md truncate" title="{{ document.notes }}"><i class="bi bi-chat-square-text mr-1.5"></i>{{ document.notes }}</p>
                        {% endif %}

                        <div class="flex gap-2 mt-4">
                            <a href="{{ document.file.url }}" target="_blank" class="doc-action-btn bg-primary-600 hover:bg-primary-700">
                                <i class="bi bi-eye"></i> View
                            </a>
                            <a href="{% url 'records:delete_document' student.id document.id %}"
                                class="doc-action-btn bg-red-600 hover:bg-red-700"
                                onclick="return confirm('Are you sure you want to delete this document?')">
                                <i class="bi bi-trash"></i> Delete
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-16">
            <div class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center text-4xl text-gray-400">
                <i class="bi bi-inbox"></i>
            </div>
            <h4 class="text-lg font-semibold text-gray-700 mb-2">No Documents Uploaded</h4>
            <p class="text-gray-500">Upload documents for this student using the button above.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Image Preview Modal -->
<div id="imageModal" class="fixed inset-0 bg-black/80 z-50 hidden items-center justify-center p-4" onclick="closeModal()">
    <span class="absolute top-4 right-6 text-white text-4xl font-bold cursor-pointer hover:text-gray-300">&times;</span>
    <img class="max-w-full max-h-full object-contain" id="modalImage" onclick="event.stopPropagation()">
</div>

<style>
    .profile-badge {
        @apply inline-flex items-center gap-2 bg-white/20 px-4 py-1.5 rounded-full font-semibold text-sm backdrop-blur-sm;
    }
    .action-btn {
        @apply inline-flex items-center gap-2 px-5 py-2.5 font-bold rounded-lg shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all;
    }
    .info-card {
        @apply bg-white rounded-2xl shadow-lg p-6 md:p-8;
    }
    .section-title {
        @apply text-xl font-bold text-primary-600 mb-6 pb-3 border-b-2 border-gray-200 flex items-center gap-3;
    }
    .info-grid {
        @apply grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-5;
    }
    .info-item {
        @apply bg-gray-50 p-4 rounded-lg border-l-4 border-primary-500;
    }
    .info-label {
        @apply block text-xs font-semibold text-gray-500 uppercase tracking-wider mb-1;
    }
    .info-value {
        @apply text-gray-800 font-medium;
    }
    .parent-title {
        @apply text-lg font-bold text-gray-700 mb-3 flex items-center gap-2;
    }
    .health-badge {
        @apply inline-flex items-center gap-2 bg-yellow-100 text-yellow-800 text-sm font-semibold px-3 py-1.5 rounded-full;
    }
    .doc-action-btn {
        @apply flex-1 inline-flex justify-center items-center gap-1.5 px-3 py-2 text-xs font-medium rounded-md text-white shadow-sm transition-colors;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    function viewDocument(url, isImage) {
        if (isImage) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            modalImg.src = url;
        } else {
            window.open(url, '_blank');
        }
    }

    function closeModal() {
        const modal = document.getElementById('imageModal');
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }

    // Close modal with Escape key
    document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
            closeModal();
        }
    });
</script>
{% endblock %}