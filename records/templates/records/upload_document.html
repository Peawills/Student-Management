{% extends "records/base.html" %} 
{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <a href="{% url 'records:student_detail' student.id %}"
      class="inline-flex items-center gap-2 text-primary-600 font-semibold hover:text-secondary-500 transition-colors mb-4">
      <i class="bi bi-arrow-left-circle"></i>
      Back to Student Profile
    </a>
    <div class="flex items-center gap-4">
      <div
        class="w-16 h-16 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-primary-500 to-secondary-500 text-white rounded-2xl shadow-lg text-3xl">
        <i class="bi bi-cloud-upload"></i>
      </div>
      <div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">Document Management</h2>
        <p class="text-gray-500 mt-1">
          For <strong>{{ student.full_name }}</strong> ({{ student.admission_no }})
        </p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Upload Form Section -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-2xl shadow-lg p-6 sticky top-24">
        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-3">
          <i class="bi bi-file-earmark-plus text-primary-500"></i>
            Upload New Document
        </h3>
          <form method="post" enctype="multipart/form-data" id="uploadForm">
            {% csrf_token %}
            
            <div class="space-y-4">
              <div>
                <label for="{{ form.name.id_for_label }}" class="form-label">Document Name</label>
                {{ form.name }}
              </div>
              <div>
                <label for="{{ form.document_type.id_for_label }}" class="form-label">Document Type</label>
                {{ form.document_type }}
              </div>
              <div>
                <label for="{{ form.file.id_for_label }}" class="form-label">File</label>
                <div
                  class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-md cursor-pointer hover:border-primary-400 transition-colors"
                  id="uploadArea">
                  <div class="space-y-1 text-center">
                    <i class="bi bi-cloud-arrow-up text-4xl text-gray-400"></i>
                    <div class="flex text-sm text-gray-600">
                      <label for="{{ form.file.id_for_label }}"
                        class="relative cursor-pointer bg-white rounded-md font-medium text-primary-600 hover:text-primary-500 focus-within:outline-none focus-within:ring-2 focus-within:ring-offset-2 focus-within:ring-primary-500">
                        <span>Upload a file</span>
                      </label>
                      <p class="pl-1">or drag and drop</p>
                    </div>
                    <p class="text-xs text-gray-500" id="fileName">PDF, DOC, JPG, PNG up to 5MB</p>
                  </div>
                </div>
                {{ form.file }}
              </div>
              <div>
                <label for="{{ form.notes.id_for_label }}" class="form-label">Notes (Optional)</label>
                {{ form.notes }}
              </div>
            </div>
            
            <div class="mt-6">
              <button type="submit"
                class="w-full flex justify-center items-center gap-2 px-4 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500"
                id="uploadBtn">
                <i class="bi bi-upload"></i>Upload Document
              </button>
            </div>
          </form>
      </div>
    </div>

    <!-- Documents List Section -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-2xl shadow-lg">
        <div class="p-6 border-b border-gray-200 flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
            <i class="bi bi-files text-primary-500"></i>
            Existing Documents
          </h3>
          <span class="bg-primary-100 text-primary-700 text-sm font-medium px-3 py-1 rounded-full">{{
            student.documents.count }} file{{ student.documents.count|pluralize }}</span>
        </div>
        <div class="p-4">
          {% if student.documents.all %}
            <div class="space-y-3">
              {% for doc in student.documents.all %}
              <div
                class="p-4 border border-gray-200 rounded-lg flex items-center gap-4 hover:bg-gray-50 hover:border-primary-300 transition-all">
                <div class="flex-shrink-0 text-3xl text-primary-500">
                  {% if doc.is_image %}
                  <i class="bi bi-file-image"></i>
                  {% elif doc.is_pdf %}
                  <i class="bi bi-file-earmark-pdf"></i>
                  {% else %}
                  <i class="bi bi-file-earmark-text"></i>
                  {% endif %}
                </div>
                <div class="flex-grow">
                  <h4 class="font-semibold text-gray-800">{{ doc.name }}</h4>
                  <div class="text-sm text-gray-500 flex items-center gap-3 mt-1">
                    <span><i class="bi bi-calendar3 mr-1"></i>{{ doc.uploaded_at|date:"M d, Y" }}</span>
                    <span><i class="bi bi-hdd mr-1"></i>{{ doc.file.size|filesizeformat }}</span>
                  </div>
                </div>
                <div class="flex-shrink-0 flex items-center gap-2">
                  <a href="{{ doc.file.url }}" target="_blank"
                    class="px-3 py-2 text-xs font-medium text-center text-white bg-primary-600 rounded-lg hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 transition-all"
                    title="View">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="{% url 'records:delete_document' student.id doc.id %}"
                    class="px-3 py-2 text-xs font-medium text-center text-white bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 transition-all"
                    title="Delete" onclick="return confirm('Are you sure you want to delete this document?')">
                    <i class="bi bi-trash"></i>
                  </a>
                </div>
              </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-16">
              <div
                class="w-24 h-24 mx-auto mb-4 bg-gray-100 rounded-full flex items-center justify-center text-4xl text-gray-400">
                <i class="bi bi-inbox"></i>
              </div>
              <h4 class="text-lg font-semibold text-gray-700 mb-2">No Documents Yet</h4>
              <p class="text-gray-500">Upload the first document using the form.</p>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Custom styles for form elements to match Tailwind theme */
  .form-input,
  .form-select,
  .form-textarea {
    @apply block w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-colors;
  }

  .form-label {
    @apply block text-sm font-semibold text-gray-700 mb-1;
  }

  /* Hide the default file input */
  input[type="file"] {
    display: none;
  }
</style>

<script>
  // Drag and drop functionality
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.querySelector('input[type="file"]');
  const fileNameDisplay = document.getElementById('fileName');
  
  if (uploadArea && fileInput) {
    uploadArea.addEventListener('click', () => fileInput.click());
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.add('border-primary-400', 'bg-primary-50');
      });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      uploadArea.addEventListener(eventName, () => {
        uploadArea.classList.remove('border-primary-400', 'bg-primary-50');
      });
    });
    
    uploadArea.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      fileInput.files = files;
      updateFileName(files);
    });
    
    fileInput.addEventListener('change', (e) => {
      if (e.target.files.length > 0) {
        updateFileName(e.target.files);
      }
    });
    
    function updateFileName(files) {
      const name = files.length > 1 ? `${files.length} files selected` : files[0].name;
      if (fileNameDisplay) fileNameDisplay.textContent = name;
    }
  }

  // Form submission with loading state
  const uploadForm = document.getElementById('uploadForm');
  const uploadBtn = document.getElementById('uploadBtn');
  
  if (uploadForm && uploadBtn) {
    uploadForm.addEventListener('submit', function() {
      uploadBtn.disabled = true;
      uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Uploading...';
    });
  });
</script>
{% endblock %}