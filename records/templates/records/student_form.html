{% extends "records/base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <a href="{% url 'records:student_list' %}"
      class="inline-flex items-center gap-2 text-primary-600 font-semibold hover:text-secondary-500 transition-colors mb-4">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 inline-block" title="arrow-left-circle"></svg>
      Back to Student List
    </a>
    <div class="flex items-start gap-4">
      <div class="w-20 h-20 flex-shrink-0 rounded-2xl shadow-lg overflow-hidden bg-gray-50 flex items-center justify-center">
        {% comment %} Image preview (falls back to an inline SVG when empty) {% endcomment %}
        <div class="relative">
          <img id="imagePreview" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23e9ecef' width='120' height='120'/%3E%3Ctext fill='%23adb5bd' font-family='sans-serif' font-size='48' x='50%25' y='50%25' text-anchor='middle' dy='.3em'%3E%3F%3C/text%3E%3C/svg%3E" alt="Student image preview" class="w-20 h-20 object-cover">
          <button id="clearImageBtn" type="button" class="absolute -top-1 -right-1 bg-white border rounded-full p-1 shadow hidden" title="Remove image">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
          </button>
        </div>
      </div>
      <div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">
        {% if student %}Edit Student{% else %}Register New Student{% endif %}
        </h2>
        <p class="text-gray-500 mt-1">
        {% if student %}Update student information and documents{% else %}Complete the form below to register a new
        student{% endif %}
        </p>
      </div>
    </div>
  </div>

  {% if form.errors %}
  <div class="alert-modern alert-danger mb-6 p-4 bg-red-50 border border-red-100 rounded-lg flex items-start gap-3">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5 text-red-600"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0zM12 9v4m0 4h.01"/></svg>
    <div>
      <h4 class="font-bold">Please fix the errors below</h4>
      <ul class="list-disc list-inside text-sm mt-2">
          {% for field, errors in form.errors.items %}
        <li><strong>{{ field|title }}:</strong> {{ errors|striptags }}</li>
          {% endfor %}
      </ul>
    </div>
    <button onclick="this.closest('.alert-modern').remove()" class="ml-auto hover:bg-white/20 p-1 rounded transition-colors text-gray-500" aria-label="Dismiss">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
    </button>
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="studentForm" novalidate>
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for field in form %}
    <div class="{% if field.field.widget.input_type == 'textarea' or field.name == 'residential_address' or field.name == 'permanent_home_address' %}md:col-span-2{% endif %}">
      <label for="{{ field.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
        {{ field.label }}
        {% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
      </label>
      {{ field }}
      {% if field.errors %}
      <div class="mt-1 text-sm text-red-600">{{ field.errors.0 }}</div>
      {% endif %}
      {% if field.help_text %}
      <small class="text-gray-500 text-xs mt-1 block">{{ field.help_text }}</small>
      {% endif %}
    </div>
    {% endfor %}
    </div>
    <div class="mt-8 flex justify-start gap-4 flex-wrap">
      <button type="submit" id="submitBtn" class="inline-flex items-center gap-2 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-transform">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4"/></svg>
        <span id="submitLabel">{% if student %}Update Student{% else %}Register Student{% endif %}</span>
      </button>

      {% if student %}
      <a href="{% url 'records:student_detail' student.pk %}" class="inline-flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-all"> 
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg> Cancel
      </a>
      {% else %}
      <button type="reset" class="inline-flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10a9 9 0 1118 0 9 9 0 01-18 0zm12-4v4h4"/></svg> Reset
      </button>
      {% endif %}
    </div>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form = document.getElementById('studentForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitLabel = document.getElementById('submitLabel');

  // Image preview handling
  const studentImageInput = form ? form.querySelector('input[type="file"][name="student_image"]') : null;
  const imagePreview = document.getElementById('imagePreview');
  const clearImageBtn = document.getElementById('clearImageBtn');

  if (studentImageInput && imagePreview) {
    studentImageInput.addEventListener('change', function (e) {
      const file = e.target.files && e.target.files[0];
      if (file) {
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert('Please upload a valid image file (JPG, PNG)');
          this.value = '';
          return;
        }
        if (file.size > 2 * 1024 * 1024) {
          alert('Image size must be less than 2MB');
          this.value = '';
          return;
        }
        const reader = new FileReader();
        reader.onload = function (ev) {
          imagePreview.src = ev.target.result;
          if (clearImageBtn) clearImageBtn.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      }
    });

    if (clearImageBtn) {
      clearImageBtn.addEventListener('click', function () {
        if (studentImageInput) studentImageInput.value = '';
        imagePreview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23e9ecef' width='120' height='120'/%3E%3Ctext fill='%23adb5bd' font-family='sans-serif' font-size='48' x='50%25' y='50%25' text-anchor='middle' dy='.3em'%3E%3F%3C/text%3E%3C/svg%3E";
        this.classList.add('hidden');
      });
    }
  }

  // Prevent accidental form abandonment
  let formModified = false;
  if (form) {
    form.addEventListener('input', function () {
      formModified = true;
    });

    form.addEventListener('submit', function () {
      formModified = false;
      if (submitBtn) {
        submitBtn.disabled = true;
        submitLabel.textContent = 'Submitting...';
      }
    });
  }

  window.addEventListener('beforeunload', function (e) {
    if (formModified) {
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      return e.returnValue;
    }
  });
});
</script>
{% endblock %}