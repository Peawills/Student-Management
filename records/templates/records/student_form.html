{% extends "records/base.html" %}
{% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="mb-6">
    <a href="{% url 'records:student_list' %}"
      class="inline-flex items-center gap-2 text-primary-600 font-semibold hover:text-secondary-500 transition-colors mb-4">
      <i class="bi bi-arrow-left-circle"></i>
      Back to Student List
    </a>
    <div class="flex items-center gap-4">
      <div
        class="w-16 h-16 flex-shrink-0 flex items-center justify-center bg-gradient-to-br from-primary-500 to-secondary-500 text-white rounded-2xl shadow-lg text-3xl">
        <i class="bi bi-person-{% if student %}pencil{% else %}plus-circle{% endif %}"></i>
      </div>
      <div>
        <h2 class="text-2xl md:text-3xl font-bold text-gray-800">
        {% if student %}Edit Student{% else %}Register New Student{% endif %}
        </h2>
        <p class="text-gray-500 mt-1">
        {% if student %}Update student information and documents{% else %}Complete the form below to register a new
        student{% endif %}
        </p>
      </div>
    </div>
  </div>

  {% if form.errors %}
  <div class="alert-modern alert-danger mb-6">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <div>
      <h4 class="font-bold">Please fix the errors below</h4>
      <ul class="list-disc list-inside text-sm mt-2">
          {% for field, errors in form.errors.items %}
        <li><strong>{{ field|title }}:</strong> {{ errors|striptags }}</li>
          {% endfor %}
      </ul>
    </div>
    <button onclick="this.parentElement.remove()" class="ml-auto hover:bg-white/20 p-1 rounded transition-colors">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  {% endif %}

  <form method="post" enctype="multipart/form-data" id="studentForm" novalidate>
    {% csrf_token %}

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {% for field in form %}
    <div class="{% if field.field.widget.input_type == 'textarea' or field.name == 'residential_address' or field.name == 'permanent_home_address' %}md:col-span-2{% endif %}">
      <label for="{{ field.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
        {{ field.label }}
        {% if field.field.required %}<span class="text-red-600">*</span>{% endif %}
      </label>
      {{ field }}
      {% if field.errors %}
      <div class="mt-1 text-sm text-red-600">{{ field.errors.0 }}</div>
      {% endif %}
      {% if field.help_text %}
      <small class="text-gray-500 text-xs mt-1 block">{{ field.help_text }}</small>
      {% endif %}
    </div>
    {% endfor %}
    </div>
    <div class="mt-8 flex justify-start gap-4 flex-wrap">
      <button type="submit"
        class="inline-flex items-center gap-2 px-8 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 hover:-translate-y-0.5 transition-all">
        <i class="bi bi-check-circle"></i>
        {% if student %}Update Student{% else %}Register Student{% endif %}
      </button>

      {% if student %}
      <a href="{% url 'records:student_detail' student.pk %}"
        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-all">
        <i class="bi bi-x-circle"></i>Cancel
      </a>
      {% else %}
      <button type="reset"
        class="inline-flex items-center gap-2 px-6 py-3 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-all">
        <i class="bi bi-arrow-counterclockwise"></i>Reset
      </button>
      {% endif %}
    </div>
  </form>
</div>

<style>
  /* Custom styles for form elements to match Tailwind theme */
  .form-input,
  .form-select,
  .form-textarea {
    @apply block w-full px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary-500/50 focus:border-primary-500 transition-colors;
  }

  .form-label {
    @apply block text-sm font-semibold text-gray-700 mb-1;
  }

  .form-input:focus,
  .form-select:focus,
  .form-textarea:focus {
    border-color: #667eea;
  }

  .form-checkbox {
    @apply h-5 w-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500;
  }

  .input-group {
    @apply flex items-center;
  }

  .input-group-icon {
    @apply px-3 py-2 bg-gray-100 border border-r-0 border-gray-300 rounded-l-lg text-gray-500;
  }

  .input-group .form-input,
  .input-group .form-select {
    @apply rounded-l-none;
  }

  .input-group:focus-within .input-group-icon {
    @apply bg-primary-50 border-primary-500 text-primary-600;
  }

  /* Apply styles to Django form widgets */
  {% for field in form %}
  {% if field.field.widget.input_type == 'text' or field.field.widget.input_type == 'email' or field.field.widget.input_type == 'number' or field.field.widget.input_type == 'date' %}
  #{{ field.auto_id }} {
    @apply form-input;
  }

  {% elif field.field.widget.input_type == 'select' %}
  #{{ field.auto_id }} {
    @apply form-select;
  }

  {% elif field.field.widget.input_type == 'checkbox' %}
  #{{ field.auto_id }} {
    @apply form-checkbox;
  }

  {% elif field.field.widget.input_type == 'file' %}
  #{{ field.auto_id }} {
    @apply block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100;
  }

  {% elif field.field.widget.input_type == 'textarea' %}
  #{{ field.auto_id }} {
    @apply form-textarea;
  }
  {% endif %}
  {% endfor %}
</style>

<script>
  const studentImageInput = document.querySelector('input[name="student_image"]');
  const imagePreview = document.getElementById('imagePreview');
  const clearImageBtn = document.getElementById('clearImageBtn');

  if (studentImageInput && imagePreview) {
    studentImageInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) {
        // Simple validation
        const validTypes = ['image/jpeg', 'image/jpg', 'image/png'];
        if (!validTypes.includes(file.type)) {
          alert('Please upload a valid image file (JPG, PNG)');
          this.value = '';
          return;
        }

        // Simple size validation (2MB)
        if (file.size > 2 * 1024 * 1024) {
          alert('Image size must be less than 2MB');
          this.value = '';
          return;
        }

        const reader = new FileReader();
        reader.onload = function (ev) {
          imagePreview.src = ev.target.result;
          if (clearImageBtn) clearImageBtn.style.display = 'inline-block';
        }
        reader.readAsDataURL(file);
      }
    });

    if (clearImageBtn) {
      clearImageBtn.addEventListener('click', function () {
        studentImageInput.value = '';
        imagePreview.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120'%3E%3Crect fill='%23e9ecef' width='120' height='120'/%3E%3Ctext fill='%23adb5bd' font-family='sans-serif' font-size='48' x='50%25' y='50%25' text-anchor='middle' dy='.3em'%3E%3F%3C/text%3E%3C/svg%3E";
        this.style.display = 'none';
      });
    }
  }

  // Prevent accidental form abandonment
  let formModified = false;
  document.getElementById('studentForm').addEventListener('input', function () {
    formModified = true;
  });

  window.addEventListener('beforeunload', function (e) {
    if (formModified) {
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      return e.returnValue;
    }
  });

  // Clear flag on submit
  document.getElementById('studentForm').addEventListener('submit', function () {
    formModified = false;
  });
</script>
{% endblock %}